# Make import work like include(./../pkg)
import os, sys
try:
    file = __file__
except:
    file = sys.argv[0]
suffix = '\\..'
path=os.path.dirname(os.path.abspath(__file__)) + suffix
sys.path.insert(0, path)
from PySide2.QtCore import Slot
import MVPBase

class Interactor(MVPBase.BaseInteractor):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.old_items = []

    def start(self, *args, **kwargs):
        super().start(*args, **kwargs)

    def itemSelectionChanged(self):
        self.event_group_blockSignals("itemSelectionChanged", True)
        self.event_group_blockSignals("image_signal", True)
        new_items = self.view.page.listWidget.selectedItems()

        # Implement in
        def isIn(item, items):
            for i in items:
                if id(item) == id(i):
                    return True
            return False

        # Find truly new items
        for new_item in new_items:
            if not isIn(new_item, self.old_items):
                index = new_item.listWidget().indexFromItem(new_item).row()
                self.presenter.model.image_select(index)

        # Find truly removed itesm
        for old_item in self.old_items:
            if not isIn(old_item, new_items):
                index = old_item.listWidget().indexFromItem(old_item).row()
                self.presenter.model.image_deselect(index)

        self.presenter.image_update()
        self.old_items = new_items
        self.event_group_blockSignals("itemSelectionChanged", False)
        self.event_group_blockSignals("image_signal", False)


    def event_all_register(self):
        """ set callbacks for events generated by view """
        v = self.view
        p = self.presenter
        add=self.event_add
        add((v.parent.window,'resized', p.on_resized), 'resized')
        add((v.keyEvent,'KeyPress', p.on_keypress))

        add((v.page.selectionWidget,'select', p.on_select_display), 'select')
        add((v.page.selectionWidget,'noselect', p.on_select_display_all), 'select')
        add((v.page.columns_choice,'valueChanged', p.on_columns_choice), "valueChanged")
        add((v.page.display,'imageClicked', p.on_image_clicked ), "image_signal")
        add((v.page.listWidget,'itemSelectionChanged', self.itemSelectionChanged), "itemSelectionChanged")

